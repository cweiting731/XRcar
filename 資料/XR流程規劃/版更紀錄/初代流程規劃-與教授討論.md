---
上層:
  - "[[XR流程規劃版更紀錄]]"
時間: 2025-09-01
修改人: 周煒庭
tags:
  - XR小車
狀態:
  - 完成
---
# 內容
1. XR裝置的控制指令不直接通過電腦Unity處理，直接傳送到小車微控器，減少資料轉換傳遞的delay
	- 建議直接使用Meta Quest 3手把控制
	- 跟電腦對接端可以使用Python server
2. 車子可以使用Unity建遊戲場景進行模擬，但可以的話製作實體車子會較好
	- 複雜地形可以用Unity建場地進行模擬
	- 可以用機器人相關的模擬 (e.g. Issac Sim)
3. 掃描環境的時候，除非一直用Meta Quest 3看著車子附近的環境，不然要預先把環境建好
	- 做避障使用

# 問題
- [x] 傳輸信號不好，要怎麼處理 [[魔導大圖書館/成大雜項/課程/資訊專題/資料/XR流程規劃/XR流程規劃.md#^BgR8eg_H0hcVCOl_jLEDf]]
- [x] 控制指令怎麼傳輸 [[魔導大圖書館/成大雜項/課程/資訊專題/資料/XR流程規劃/XR流程規劃.md#^cKxInVWA1ux63HtCaCcth]]
- [x] 避障如何設計 [[魔導大圖書館/成大雜項/課程/資訊專題/資料/XR流程規劃/XR流程規劃.md#^Nar1WN4si_jxbp_GE-bGD]]

---
# 1) 傳輸信號不好，要怎麼處理

把「控制鏈」與「視訊/遙測鏈」分開思考，因為它們走不同通道。

**A. 控制鏈（控制器 → Raspberry Pi）**

- **優先選項：藍牙 HID（Xbox/PS 手把）或 2.4GHz RC 接收器**
    
    - 藍牙：開啟 _Adaptive Frequency Hopping_、把 connection interval 設 7.5–15 ms；若 RSSI < 閾值 → 自動降採樣至 30–50 Hz 並限速。
        
    - RC 接收器（SBUS/CRSF/ELRS）：天然低延遲、抗干擾佳；用 USB/UART 接到 Pi。
        
- **備援路徑：Wi-Fi UDP/QUIC**（同一手把或 XR 裝置經 Wi-Fi 直射 Pi）；健康檢查(心跳、RTT、丟包率)超門檻就切換。
    
- **包級韌性**：控制包重送不追求可靠（低延遲優先），但可**雙送一收**（duplicate & filter）；加 CRC 校驗。
    
- **斷鏈保護**：Pi 偵測 `t_now - t_last_cmd > 200 ms` → 進 failsafe（限速→居中→煞停），ESP32 再設**硬 watchdog**防 Pi 當機。
    

**B. 視訊/遙測鏈（Raspberry Pi → Unity/XR）**

- **WebRTC（SRTP/UDP）ABR 自適應**：動態調整解析度/幀率/碼率；IDR 每 1–2 s；buffer 80–150 ms。
    
- **丟包對策**：啟用 NACK + FEC（視訊），遙測則使用小包（≤200 B）＋可選 XOR parity。
    
- **多路備援**：Wi-Fi 為主、4G/LTE 熱點備援；健康探測自動切換。
    
- **降級規則**：頻寬差時先降畫質/幀率，遙測優先保留「速度/電量/E-Stop 狀態」。
    

> 重點：**控制不經過 Unity**，所以即便視訊差，車仍可被穩定控制；反之，一旦控制鏈品質差，就立即進降速/剎停流程，不靠畫面判斷。 

---

# 2) 控制指令怎麼傳輸（端到端協定）

**路徑**：控制器 →（藍牙/2.4G/UDP）→ Raspberry Pi →（UART 115200 或 USB CDC）→ ESP32 → ESC/舵機

**A. 控制器 → Raspberry Pi**

- **藍牙 HID**：讀取按鍵/軸值，封裝為 50–100 Hz 控制訊框。
    
- **或 2.4G RC 接收器**：從 SBUS/CRSF 解析通道值；或自訂 **Wi-Fi UDP/QUIC DataChannel**（partial reliability）。
    

**B. 訊框格式（Pi→ESP32，建議 32–40 bytes）：**

`struct ControlPkt {   uint16 seq;        // 序號   uint32 t_ms;       // 時戳   int16  throttle;   // -1000..1000   int16  steer;      // -1000..1000   uint8  mode;       // 0:manual 1:assist 2:auto   uint8  flags;      // bit0:E-Stop, bit1:lights...   uint16 crc;        // CRC-16 }`

- **頻率**：50 Hz（網況差可自動降到 25 Hz）。
    
- **策略**：unordered、no-retransmit；每 N 包重送一次最新包（duplicate）；ESP32 只接受**序號最新**的包。
    
- **輸出整形**：ESP32 端做限斜率（slew-rate）與小死區（deadband），舵機角度/速度閉迴路 PID。
    
- **E-Stop 雙重化**：
    
    - 軟體：flags 觸發 → 立即 PWM=0、制動。
        
    - 硬體：Pi 或獨立按鈕 → 繼電器切 ESC 供電（<50 ms 生效）。
        
- **權限/接管**：模式切換雙確認；失聯自動退出人控→failsafe。
    

---

# 3) 避障如何設計（車載在 Pi，與人控解耦）

**分層安全 + 共享控制**，避免把避障放在 Unity 或遠端。

**A. 感測器配置（依預算/場景擇一或混合）**

- 前向 **ToF/超音波** 2–3 顆（0.2–2 m，10–20 Hz）。
    
- **2D LiDAR**（270°/10–15 m）或 深度相機（中距離）。
    
- 輪編碼器 + IMU 做里程與姿態；必要時 VIO。
    

**B. 反應式「安全泡泡」（毫秒級，永遠開啟）**

- **TTC（碰撞時間）判斷**：`TTC = d / v_rel`；若 `TTC < T_brake + margin` → 立即限扭/煞停。
    
- **動態安全距離**：`d_safe = v*τ + v²/(2a_brake)`（τ=控制總延遲含人反應；`a_brake` 實測）。用來限制**最大允許速度**。
    
- **虛擬保險桿**：前方 ±30–45°、3–5 m 區域有障礙就限速/停車；側向窄扇區限制大角度打舵。
    

**C. 局部規劃（百毫秒級，可選）**

- 先上 **VFH**（簡單、穩定），之後可換 **DWA/TEB**（含動力學）。
    
- **共享控制（Shared Control）**：
    
    - 人給期望舵角/速度，規劃器只在「會撞」時微調或覆蓋；
        
    - 規劃器輸出再經 ESP32 限斜率，確保不抖動。
        

**D. 降級/失聯規則**

- 感測可信度下降（雨霧/逆光/強噪）→ 自動降速、只留剎停泡泡。
    
- 控制鏈連續 >200 ms 無指令 → 煞停；>2 s 維持**硬停**直到操作者復位。
    

**建議測試項目**

- 連線：人為注入 20–30% 丟包、RTT 抖動 30→200 ms，驗證降級與 E-Stop。
    
- 制動：量測 `a_brake` 與 0→停距離，校正 `d_safe` 與 TTC 門檻。
    
- 避障：靜態障礙（箱子）、動態行人/車模；不同速度下不撞擊、最大繞行偏差。

